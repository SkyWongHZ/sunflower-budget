name: Deploy to Development Server

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•'
        required: false
        default: false
        type: boolean
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æž„å»ºé•œåƒ'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  NAMESPACE: sunflower-budget
  IMAGE_NAME: sunflower-budget-app

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci
        npx prisma generate

    - name: Run tests
      if: ${{ !inputs.skip_tests }}
      run: npm run test

    - name: Build application
      run: npm run build

    - name: Login to Aliyun Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_CR_PASSWORD }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:dev
        cache-from: type=gha
        cache-to: type=gha,mode=max
        no-cache: ${{ inputs.force_rebuild }}

    - name: Deploy to development server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SERVER_SSH_KEY }}
        port: 22
        script: |
          # åˆ›å»ºåº”ç”¨ç›®å½•
          mkdir -p /opt/sunflower-budget-dev
          cd /opt/sunflower-budget-dev

          # åœæ­¢æ—§æœåŠ¡
          docker compose down || true

          # ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
          echo "${{ secrets.ALIYUN_CR_PASSWORD }}" | docker login ${{ env.REGISTRY }} -u "${{ secrets.ALIYUN_USERNAME }}" --password-stdin

          # åˆ›å»ºå¼€å‘çŽ¯å¢ƒé…ç½®æ–‡ä»¶
          cat > .env << EOF
          NODE_ENV=development
          DATABASE_URL=mongodb://root:19931010@${{ secrets.ALIYUN_HOST }}:27017/sunflower_budget?authSource=admin&replicaSet=rs0
          MAIL_USER=noreply@example.com
          MAIL_PASS=temp_password
          MAIL_FROM_NAME=Sunflower Budget
          REDIS_PASSWORD=temp_redis_pass
          MINIO_ENDPOINT=${{ secrets.MINIO_ENDPOINT }}
          MINIO_PORT=9000
          MINIO_USE_SSL=${{ secrets.MINIO_USE_SSL }}
          MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY }}
          MINIO_BUCKET=sunflower-budget
          WORK_WEIXIN_WEBHOOK_KEY=${{ secrets.JWT_SECRET }}
          EOF

          # åˆ›å»ºå¼€å‘çŽ¯å¢ƒ docker-compose æ–‡ä»¶
          cat > docker-compose.yml << 'EOF'
          version: '3.8'
          services:
            app:
              image: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:dev
              container_name: sunflower-budget-dev
              ports:
                - "3000:3000"
              env_file:
                - .env
              restart: unless-stopped
              networks:
                - dev-network

            nginx:
              image: nginx:alpine
              container_name: sunflower-budget-nginx-dev
              ports:
                - "8899:8899"
              volumes:
                - ./nginx.conf:/etc/nginx/nginx.conf:ro
              depends_on:
                - app
              restart: unless-stopped
              networks:
                - dev-network

          networks:
            dev-network:
              driver: bridge
          EOF

          # ä¸‹è½½nginxé…ç½®æ–‡ä»¶
          curl -o nginx.conf https://raw.githubusercontent.com/SkyWongHZ/sunflower-budget/main/nginx.conf

          # æ‹‰å–æœ€æ–°é•œåƒå¹¶å¯åŠ¨
          docker pull ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:dev
          docker compose up -d

          # æ˜¾ç¤ºè¿è¡ŒçŠ¶æ€
          echo "=== æœåŠ¡çŠ¶æ€ ==="
          docker compose ps
          
          echo ""
          echo "=== åº”ç”¨æ—¥å¿—ï¼ˆæœ€åŽ10è¡Œï¼‰==="
          docker logs --tail 10 sunflower-budget-dev || echo "åº”ç”¨å®¹å™¨è¿˜åœ¨å¯åŠ¨ä¸­..."

          echo ""
          echo "âœ… å¼€å‘çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ!"
          echo "ðŸŒ APIè®¿é—®åœ°å€: http://${{ secrets.ALIYUN_HOST }}:8899/api"
          echo "ðŸ“Š APIæ–‡æ¡£: http://${{ secrets.ALIYUN_HOST }}:8899/api/docs" 